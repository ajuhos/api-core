{"version":3,"file":"ApiEdgeQuery.js","sourceRoot":"","sources":["../../../src/edge/ApiEdgeQuery.ts"],"names":[],"mappings":"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","sourcesContent":["import {ApiEdgeDefinition} from './ApiEdgeDefinition';\nimport {ApiEdgeQueryType} from './ApiEdgeQueryType';\nimport {ApiEdgeQueryContext} from \"./ApiEdgeQueryContext\";\nimport {ApiEdgeQueryResponse} from \"./ApiEdgeQueryResponse\";\nimport {ApiEdgeError} from \"../query/ApiEdgeError\";\nimport {ApiEdgeSchemaTransformation} from \"./ApiEdgeSchema\";\n\nexport class ApiEdgeQuery {\n\n    /**\n     * The API edge to execute the query on.\n     */\n    edge: ApiEdgeDefinition;\n\n    /**\n     * The type of query to execute.\n     */\n    type: ApiEdgeQueryType;\n\n    /**\n     * The list of parameters to use during execution.\n     */\n    context: ApiEdgeQueryContext;\n\n    /**\n     * The list of parameters to use during execution.\n     */\n    body: any;\n\n    private originalFields: string[] = [];\n\n    /**\n     * Create a new API Edge Query for the specified API Edge with the specified parameters.\n     * @param {ApiEdgeDefinition} edge\n     * @param {ApiEdgeQueryType} type\n     * @param {ApiEdgeQueryContext} context\n     * @param {object} body\n     */\n    constructor(edge: ApiEdgeDefinition,\n                type: ApiEdgeQueryType = ApiEdgeQueryType.Get,\n                context: ApiEdgeQueryContext = new ApiEdgeQueryContext(),\n                body: any = null) {\n        this.edge = edge;\n        this.type = type;\n        this.context = context;\n        this.body = body;\n    }\n\n    private applySchemaOnInputItem = (item: any) => {\n        let output = {};\n        this.edge.schema.transformations.forEach((transformation: ApiEdgeSchemaTransformation) => {\n            if(transformation.parsedField(item) !== undefined)\n                transformation.applyToInput(item, output)\n        });\n\n        return output\n    };\n\n    private applySchemaOnItem = (item: any): any => {\n        let output = {};\n\n        if(this.context.fields.length) {\n            this.edge.schema.transformations.forEach((transformation: ApiEdgeSchemaTransformation) => {\n                if(this.originalFields.indexOf(transformation.affectedSchemaField) != -1)\n                    transformation.applyToOutput(item, output)\n            });\n        }\n        else {\n            this.edge.schema.transformations.forEach((transformation: ApiEdgeSchemaTransformation) => {\n                transformation.applyToOutput(item, output)\n            });\n        }\n\n        return output\n    };\n\n/*    private applyInputListSchema = (value: ApiEdgeQueryResponse) => {\n        if(!this.edge.schema)\n            return value;\n\n        value.data = (value.data as any[]).map((item: any) => this.applySchemaOnInputItem(item));\n        return value\n    };*/\n\n    private applyListSchema = (value: ApiEdgeQueryResponse) => {\n        if(!this.edge.schema)\n            return value;\n\n        value.data = (value.data as any[]).map((item: any) => this.applySchemaOnItem(item));\n        return value\n    };\n\n    private applyInputSchema = (value: any): any|Promise<any> => {\n        if(!this.edge.schema)\n            return value;\n\n        return this.applySchemaOnInputItem(value)\n    };\n\n    private applySchema = (value: ApiEdgeQueryResponse): ApiEdgeQueryResponse|Promise<ApiEdgeQueryResponse> => {\n        if(!this.edge.schema)\n            return value;\n\n        value.data = this.applySchemaOnItem(value.data);\n        return value\n    };\n\n    execute = (): Promise<ApiEdgeQueryResponse> => {\n        if(this.body) {\n            this.body = this.applyInputSchema(this.body)\n        }\n\n        if(this.context.fields.length) {\n            this.originalFields = this.context.fields;\n            this.context.fields = this.edge.schema.transformFields(this.context.fields);\n        }\n\n        switch (this.type) {\n            case ApiEdgeQueryType.Get:\n                return this.edge.getEntry(this.context).then(this.applySchema);\n            case ApiEdgeQueryType.Exists:\n                return this.edge.exists(this.context);\n            case ApiEdgeQueryType.Create:\n                return this.edge.createEntry(this.context, this.body).then(this.applySchema);\n            case ApiEdgeQueryType.Delete:\n                return this.edge.removeEntry(this.context, this.body).then(this.applySchema);\n            case ApiEdgeQueryType.Update:\n                return this.edge.updateEntry(this.context, this.body).then(this.applySchema);\n            case ApiEdgeQueryType.Patch:\n                return this.edge.patchEntry(this.context, this.body).then(this.applySchema);\n            case ApiEdgeQueryType.List:\n                return this.edge.listEntries(this.context).then(this.applyListSchema);\n            default:\n                throw new ApiEdgeError(500, \"Unsupported Query Type\")\n        }\n    }\n}"]}